<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EcoClean - Sustainable Digital Waste Management</title>
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <!-- Custom CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles2.css') }}"
    />
    <!-- Google Drive API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
      /* Enhanced Service Grid Styles */
      .main-grid {
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
        padding: 2.5rem;
        margin-top: 80px;
        max-width: 1600px;
        margin-left: auto;
        margin-right: auto;
      }

      .grid-section {
        width: 100%;
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .grid-section::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: linear-gradient(90deg, #28a745, #20c997);
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.4s ease;
      }

      .grid-section:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
      }

      .grid-section:hover::before {
        transform: scaleX(1);
      }

      .grid-section h2 {
        color: #1a1f25;
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 1.75rem;
        position: relative;
        display: inline-block;
        padding-bottom: 0.5rem;
      }

      .grid-section h2 i {
        margin-right: 12px;
        background: linear-gradient(45deg, #28a745, #20c997);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 1.75rem;
      }

      .grid-section h2::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 50px;
        height: 3px;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
      }

      .grid-section:hover h2::after {
        width: 100%;
      }

      .card {
        height: 100%;
        border: none;
        border-radius: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
        background: transparent;
      }

      .card-body {
        padding: 1.75rem;
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .form-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
      }

      .form-control {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        font-size: 1rem;
        background: #ffffff;
      }

      .form-control:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.15);
      }

      .btn {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        font-size: 1.1rem;
        border-radius: 12px;
        transition: all 0.3s ease;
      }

      .btn-success {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        position: relative;
        overflow: hidden;
        z-index: 1;
      }

      .btn-success::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 0;
        height: 100%;
        background: linear-gradient(45deg, #20c997, #28a745);
        transition: width 0.3s ease;
        z-index: -1;
      }

      .btn-success:hover::before {
        width: 100%;
      }

      .btn-success:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(40, 167, 69, 0.2);
      }

      .btn-danger {
        background: linear-gradient(45deg, #dc3545, #e83e8c);
        border: none;
        transition: all 0.3s ease;
      }

      .btn-danger:hover {
        background: linear-gradient(45deg, #e83e8c, #dc3545);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
      }

      .btn-warning {
        background: linear-gradient(45deg, #ffc107, #fd7e14);
        border: none;
        color: white;
        transition: all 0.3s ease;
      }

      .btn-warning:hover {
        background: linear-gradient(45deg, #fd7e14, #ffc107);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
      }

      .btn-sdg {
        background: linear-gradient(45deg, #17a2b8, #007bff);
        color: white;
        border: none;
        transition: all 0.3s ease;
      }

      .btn-sdg:hover {
        background: linear-gradient(45deg, #007bff, #17a2b8);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
      }

      /* Email info section enhancement */
      .email-info {
        background: linear-gradient(
          135deg,
          rgba(40, 167, 69, 0.1) 0%,
          rgba(32, 201, 151, 0.1) 100%
        );
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
        border-left: 4px solid #28a745;
      }

      .email-info h5 {
        color: #28a745;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      /* SDG info section enhancement */
      .sdg-info {
        background: linear-gradient(
          135deg,
          rgba(0, 123, 255, 0.1) 0%,
          rgba(23, 162, 184, 0.1) 100%
        );
        padding: 1.5rem;
        border-radius: 10px;
        border-left: 4px solid #17a2b8;
      }

      .sdg-info h5 {
        color: #17a2b8;
        font-weight: 600;
      }

      /* Chat bot enhancement */
      .chat-bot {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
      }

      .chat-bot .btn {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }
        70% {
          box-shadow: 0 0 0 15px rgba(40, 167, 69, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
        }
      }

      .chat-window {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 350px;
        height: 450px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        display: none;
        flex-direction: column;
        overflow: hidden;
        transform: translateY(20px);
        opacity: 0;
        transition: all 0.3s ease;
      }

      .chat-window.active {
        display: flex;
        transform: translateY(0);
        opacity: 1;
      }

      /* Toast enhancement */
      .toast {
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #28a745;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .main-grid {
          grid-template-columns: 1fr;
          padding: 1.5rem;
          gap: 2rem;
        }

        .grid-section {
          min-height: auto;
          padding: 1.5rem;
        }

        .grid-section h2 {
          font-size: 1.5rem;
        }

        .btn {
          font-size: 1rem;
          padding: 0.6rem 1.2rem;
        }
      }

      /* Add Google Drive connection button styles */
      .drive-connect {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 15px 30px;
        background: linear-gradient(45deg, #4285f4, #34a853);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .drive-connect:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        background: linear-gradient(45deg, #34a853, #4285f4);
      }

      .drive-connect i {
        font-size: 1.4rem;
      }

      .connection-status {
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      /* Add Google Drive connection section styles */
      .drive-section {
        background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
        padding: 2.5rem;
        border-radius: 15px;
        color: white;
        margin-bottom: 2rem;
        text-align: center;
        box-shadow: 0 10px 25px rgba(66, 133, 244, 0.2);
        position: relative;
        overflow: hidden;
      }

      .drive-section::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          45deg,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0) 100%
        );
        z-index: 1;
      }

      .drive-section h2 {
        color: white !important;
        margin-bottom: 1.5rem;
        font-size: 2rem;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .drive-btn {
        background: white;
        color: #4285f4;
        padding: 1rem 2.5rem;
        border-radius: 30px;
        font-weight: 600;
        border: none;
        transition: all 0.3s ease;
        font-size: 1.2rem;
        display: inline-flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .drive-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(255, 255, 255, 0.3);
        background: #f8f9fa;
      }

      .drive-btn i {
        font-size: 1.4rem;
      }

      .service-overlay p {
        color: white;
        font-size: 1.2rem;
        text-align: center;
        padding: 1rem;
      }

      /* Add styles for carbon impact display */
      .carbon-impact {
        background: linear-gradient(
          135deg,
          rgba(40, 167, 69, 0.1) 0%,
          rgba(32, 201, 151, 0.1) 100%
        );
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
      }
      .carbon-impact h6 {
        color: #28a745;
        margin-bottom: 0.5rem;
      }
      .file-item {
        border-left: 4px solid #28a745;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
      }

      /* Add styles for the new wrapper */
      .drive-connection-wrapper {
        grid-column: 1 / -1;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 2rem;
        padding: 0 1rem;
      }

      .drive-section {
        width: 100%;
        max-width: 800px;
        background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
        padding: 3rem;
        border-radius: 20px;
        color: white;
        text-align: center;
        box-shadow: 0 15px 30px rgba(66, 133, 244, 0.25);
        position: relative;
        overflow: hidden;
        transform: translateY(0);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .drive-section:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(66, 133, 244, 0.35);
      }

      .drive-content {
        position: relative;
        z-index: 2;
      }

      .drive-section h2 {
        color: white !important;
        margin-bottom: 1.5rem;
        font-size: 2.5rem;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .drive-section p {
        font-size: 1.2rem;
        opacity: 0.9;
        margin-bottom: 2rem;
      }

      .drive-btn {
        background: white;
        color: #4285f4;
        padding: 1.2rem 3rem;
        border-radius: 50px;
        font-weight: 700;
        border: none;
        transition: all 0.3s ease;
        font-size: 1.2rem;
        display: inline-flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        text-transform: uppercase;
        letter-spacing: 1px;
        position: relative;
        overflow: hidden;
      }

      .drive-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          120deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: 0.5s;
      }

      .drive-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.25);
        background: #f8f9fa;
      }

      .drive-btn:hover::before {
        left: 100%;
      }

      .drive-btn i {
        font-size: 1.4rem;
      }

      @media (max-width: 768px) {
        .drive-section {
          padding: 2rem 1.5rem;
        }

        .drive-section h2 {
          font-size: 2rem;
        }

        .drive-btn {
          padding: 1rem 2rem;
          font-size: 1.1rem;
        }
      }

      /* File Analysis Results Styles */
      .file-analysis-results {
        display: none;
        margin-top: 2rem;
      }

      .file-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border-left: 4px solid #28a745;
        transition: all 0.3s ease;
      }

      .file-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      }

      .file-stats {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
        flex-wrap: wrap;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .stat-item i {
        color: #28a745;
      }

      .file-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
      }

      .carbon-indicator {
        width: 100%;
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        margin-top: 1rem;
        overflow: hidden;
      }

      .carbon-bar {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
      }

      /* Analysis Summary Card */
      .analysis-summary {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 2rem;
      }

      .summary-stats {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
      }

      .summary-stat {
        text-align: center;
      }

      .summary-stat h3 {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
      }

      .summary-stat p {
        opacity: 0.9;
        margin: 0;
      }

      /* Add these new styles for the charts */
      .card-body {
        padding: 1rem;
      }

      .card-title {
        font-size: 1rem;
        font-weight: 600;
        color: #2c3e50;
      }

      /* Make charts more compact */
      .row.g-4 {
        margin: 0 -0.5rem;
      }

      .row.g-4 > div {
        padding: 0 0.5rem;
      }

      .card {
        margin-bottom: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      /* Chart container styles */
      .chart-container {
        height: 250px;
        position: relative;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <!-- Google Drive Connection Button -->
    <button class="drive-connect" onclick="connectDrive()">
      <i class="fab fa-google-drive"></i>
      {% if drive_connected %} Disconnect Google Drive {% else %} Connect Google
      Drive {% endif %}
    </button>

    {% if drive_connected %}
    <div class="connection-status connected">
      <i class="fas fa-check-circle"></i> Connected to Google Drive
    </div>
    {% endif %}

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#"
          ><i class="fas fa-leaf"></i> EcoClean</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link active" href="{{ url_for('firsthome') }}"
                >Home</a
              >
            </li>
            {% if drive_connected %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('list_drive_files') }}">
                <i class="fab fa-google-drive"></i> Google Drive Files
              </a>
            </li>
            {% endif %}
            <li class="nav-item">
              <a class="nav-link btn btn-success ms-2" href="#get-started"
                >Get Started</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content Grid -->
    <div class="main-grid">
      <!-- Google Drive Connection Section -->
      <div class="drive-connection-wrapper">
        <div class="drive-section">
          <div class="drive-content">
            <h2><i class="fab fa-google-drive"></i> Google Drive Connection</h2>
            <p class="mb-4">
              You can connect or disconnect your Google Drive anytime to enhance
              features.
            </p>
            <div class="d-flex gap-3 justify-content-center">
              <button
                class="btn btn-outline-light btn-lg"
                onclick="connectDrive()"
              >
                <i class="fab fa-google-drive"></i> Connect Google Drive
              </button>
              <button
                class="btn btn-outline-light btn-lg"
                onclick="disconnectDrive()"
              >
                <i class="fas fa-unlink"></i> Disconnect
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ðŸ”˜ File Explorer Section (Insert This Below Drive Section) -->
      <div class="drive-connection-wrapper">
        <div class="drive-section">
          <div class="drive-content text-center">
            <h2><i class="fas fa-folder-open"></i> File Explorer Cleaner</h2>
            <p class="mb-4">
              Clean your local system by scanning folders and managing files.
            </p>
            <button
              class="btn btn-outline-light btn-lg mb-3"
              onclick="browseFolder()"
            >
              <i class="fas fa-search"></i> Browse Folder
            </button>

            <div id="folder-path" class="text-muted"></div>
            <ul class="list-group mt-3" id="file-list"></ul>
          </div>
        </div>
      </div>
      <!-- ðŸ” Analyze and Find Duplicates in Browsed Files Section -->
      <div class="grid-section">
  <h2><i class="fas fa-folder-tree"></i> Analyze and Find Duplicates in Browsed Files</h2>
  <div class="card">
    <div class="card-body">
      <p class="text-muted">
        <i class="fas fa-info-circle me-2"></i>
        This tool analyzes the files you browsed from File Explorer, calculates per-file carbon emissions, and detects duplicates.
      </p>

      <button class="btn btn-success w-100 mb-3" id="analyzeBrowsedBtn">
        <i class="fas fa-search"></i> Analyze Browsed Files
      </button>

      <!-- Analysis Results -->
      <div id="browsedAnalysisResults" style="display: none">
        <div class="alert alert-info">
          <h5><i class="fas fa-chart-pie me-2"></i>Scan Results</h5>
          <div class="row mt-3">
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <i class="fas fa-file me-2 text-primary"></i>
                <div>
                  <small class="text-muted">Total Files</small>
                  <h4 class="mb-0" id="scanTotalFilesLocal">0</h4>
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <i class="fas fa-copy me-2 text-warning"></i>
                <div>
                  <small class="text-muted">Duplicate Groups</small>
                  <h4 class="mb-0" id="duplicateGroupsLocal">0</h4>
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <i class="fas fa-leaf me-2 text-success"></i>
                <div>
                  <small class="text-muted">Total COâ‚‚</small>
                  <h4 class="mb-0" id="scanTotalCO2Local">0 g/year</h4>
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <i class="fas fa-recycle me-2 text-danger"></i>
                <div>
                  <small class="text-muted">Duplicate COâ‚‚</small>
                  <h4 class="mb-0" id="duplicateCO2Local">0 g/year</h4>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Top Emitters -->
        <div class="card mt-4">
          <div class="card-header">
            <i class="fas fa-fire text-danger me-2"></i> Top COâ‚‚ Emitting Files
          </div>
          <div class="table-responsive">
            <table class="table table-striped mb-0">
              <thead>
                <tr>
                  <th>#</th>
                  <th>File Name</th>
                  <th>Size</th>
                  <th>COâ‚‚ Emission</th>
                  <th>Last Accessed</th>
                </tr>
              </thead>
              <tbody id="topEmittersListLocal">
                <!-- JS will inject rows -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Duplicate Groups -->
        <div id="duplicateListLocal" class="mt-4">
          <h5><i class="fas fa-list me-2"></i>Duplicate File Groups</h5>
          <div class="list-group" id="duplicateFilesListLocal">
            <!-- JS will inject duplicate groups -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


      <!-- Get Started Section with File Analysis -->
      <section id="get-started" class="grid-section">
        <h2 class="text-center mb-4">
          <i class="fas fa-rocket"></i> Analyze Gdrive Files
        </h2>
        <div class="card shadow">
          <div class="card-body">
            <form id="analyzeForm">
              <button
                type="submit"
                class="btn btn-success w-100"
                id="analyzeBtn"
              >
                <i class="fas fa-search"></i>Analyze Files with CO2 Contribution
              </button>
            </form>

            <div id="fileAnalysisResults" class="file-analysis-results">
              <!-- Analysis Summary -->
              <div class="analysis-summary">
                <h4><i class="fas fa-chart-pie"></i> Analysis Summary</h4>
                <div class="summary-stats">
                  <div class="summary-stat">
                    <h3 id="totalFiles">0</h3>
                    <p>Total Files</p>
                  </div>
                  <div class="summary-stat">
                    <h3 id="totalCO2">0</h3>
                    <p>Total CO2 (g/year)</p>
                  </div>
                  <div class="summary-stat">
                    <h3 id="potentialReduction">0</h3>
                    <p>Potential CO2 Reduction</p>
                  </div>
                </div>
              </div>

              <!-- File Cards Container -->
              <div id="fileCards">
                <!-- File cards will be added here dynamically -->
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Duplicate File Scanner Section -->
      <div class="grid-section">
        <h2><i class="fas fa-copy"></i> Duplicate File Scanner</h2>
        <div class="card">
          <div class="card-body">
            <div class="mb-4">
              <p class="text-muted">
                <i class="fas fa-info-circle me-2"></i>
                Scan your Google Drive for duplicate files and reduce your
                digital carbon footprint. The scan will identify files with
                identical content, even if they have different names.
              </p>
              <button id="scanDuplicatesBtn" class="btn btn-success w-100">
                <i class="fas fa-search"></i> Scan for Duplicates
              </button>
            </div>

            <!-- Loading Spinner -->
            <div
              id="scanningSpinner"
              class="text-center my-4"
              style="display: none"
            >
              <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">
                Scanning for duplicates... This may take a few moments.
              </p>
            </div>

            <!-- Error Alert -->
            <div
              id="scanError"
              class="alert alert-danger"
              style="display: none"
              role="alert"
            >
              <i class="fas fa-exclamation-circle me-2"></i>
              <span id="errorMessage"></span>
            </div>

            <div id="scanResults" style="display: none">
              <div class="alert alert-info">
                <h5><i class="fas fa-chart-pie me-2"></i>Scan Results</h5>
                <div class="row mt-3">
                  <div class="col-md-6 mb-2">
                    <div class="d-flex align-items-center">
                      <i class="fas fa-file me-2 text-primary"></i>
                      <div>
                        <small class="text-muted">Total Files</small>
                        <h4 class="mb-0" id="scanTotalFiles">0</h4>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 mb-2">
                    <div class="d-flex align-items-center">
                      <i class="fas fa-copy me-2 text-warning"></i>
                      <div>
                        <small class="text-muted">Duplicate Groups</small>
                        <h4 class="mb-0" id="duplicateGroups">0</h4>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 mb-2">
                    <div class="d-flex align-items-center">
                      <i class="fas fa-leaf me-2 text-success"></i>
                      <div>
                        <small class="text-muted">Total CO2</small>
                        <h4 class="mb-0" id="scanTotalCO2">0 g/year</h4>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 mb-2">
                    <div class="d-flex align-items-center">
                      <i class="fas fa-recycle me-2 text-danger"></i>
                      <div>
                        <small class="text-muted">Duplicate CO2</small>
                        <h4 class="mb-0" id="duplicateCO2">0 g/year</h4>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div id="duplicateList" class="mt-4">
                <h5><i class="fas fa-list me-2"></i>Duplicate File Groups</h5>
                <div class="list-group" id="duplicateFilesList">
                  <!-- Duplicate groups will be listed here -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Email Cleanup Section -->
      <div class="grid-section">
        <h2><i class="fas fa-envelope"></i>Email Cleanup</h2>
        <div class="row">
          <div class="col-md-12">
            <div class="card">
              <div class="card-body">
                <div class="email-info">
                  <h5>Clean up your email inbox</h5>
                  <p>
                    Reduce your digital carbon footprint by cleaning up your
                    email inbox. Remove unnecessary emails and attachments to
                    save storage space and energy.
                  </p>
                </div>
                <div class="d-grid gap-2 mt-4">
                  <a href="{{ url_for('base') }}" class="btn btn-success">
                    <i class="fas fa-arrow-right me-2"></i>Proceed to Email
                    Cleanup
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SDG-12 Section -->
      <section id="sdg-12" class="grid-section">
        <div class="container">
          <h2 class="text-center mb-4">
            <i class="fas fa-globe"></i> SDG-12 Impact
          </h2>
          <div class="card shadow">
            <div class="card-body">
              <div class="sdg-info mb-4">
                <h5 class="text-center">
                  Sustainable Consumption and Production
                </h5>
                <p class="text-center">
                  Track your digital consumption patterns and their
                  environmental impact
                </p>
              </div>
              <div class="text-center">
                <button
                  class="btn btn-sdg w-100"
                  data-href="{{ url_for('home3') }}"
                >
                  Learn More
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Toast Notification -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div
        id="optimizeToast"
        class="toast"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="toast-header">
          <i class="fas fa-check-circle text-success me-2"></i>
          <strong class="me-auto">Success</strong>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
        <div class="toast-body">
          <div class="d-flex align-items-center">
            <i class="fas fa-shield-alt text-success me-3"></i>
            <div>
              <h6 class="mb-1">Storage Optimized Successfully!</h6>
              <p class="mb-0">
                Your digital carbon footprint has been reduced.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/script2.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Check Google Drive connection status on page load
      document.addEventListener("DOMContentLoaded", function () {
        checkDriveConnection();
        // Load the Google Drive Picker API
        gapi.load("picker", () => {});
      });

      function checkDriveConnection() {
        fetch("/check_drive_connection")
          .then((response) => response.json())
          .then((data) => {
            if (data.connected) {
              unlockServices();
              updateConnectionStatus(true);
            } else {
              lockServices();
              updateConnectionStatus(false);
            }
          })
          .catch((error) => {
            console.error("Error checking connection:", error);
            lockServices();
            updateConnectionStatus(false);
          });
      }

      function updateConnectionStatus(connected) {
        const statusElement = document.querySelector(".connection-status");
        if (statusElement) {
          if (connected) {
            statusElement.classList.remove("disconnected");
            statusElement.classList.add("connected");
            statusElement.innerHTML =
              '<i class="fas fa-check-circle"></i> Connected to Google Drive';
          } else {
            statusElement.classList.remove("connected");
            statusElement.classList.add("disconnected");
            statusElement.innerHTML =
              '<i class="fas fa-times-circle"></i> Not connected to Google Drive';
          }
        }
      }

      function unlockServices() {
        document.querySelectorAll(".grid-section").forEach((section) => {
          section.classList.remove("service-locked");
          const overlay = section.querySelector(".service-overlay");
          if (overlay) {
            overlay.style.display = "none";
          }
        });
      }

      function lockServices() {
        document.querySelectorAll(".grid-section").forEach((section) => {
          if (
            !section.id.includes("email-cleanup") &&
            !section.id.includes("sdg-12")
          ) {
            section.classList.add("service-locked");
            const overlay = section.querySelector(".service-overlay");
            if (overlay) {
              overlay.style.display = "flex";
            }
          }
        });
      }

      function connectDrive() {
        window.location.href = "{{ url_for('connect_google_drive') }}";
      }

      function disconnectDrive() {
        if (
          confirm(
            "Are you sure you want to disconnect Google Drive? This will limit access to features."
          )
        ) {
          fetch("/disconnect_drive", {
            method: "POST",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                window.location.reload();
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              showAlert("Error disconnecting from Google Drive", "danger");
            });
        }
      }

      function selectDriveFolder() {
        fetch("/check_drive_connection")
          .then((response) => response.json())
          .then((data) => {
            if (data.connected) {
              launchDrivePicker();
            } else {
              showAlert("Please connect to Google Drive first", "warning");
              setTimeout(() => {
                window.location.href = "{{ url_for('connect_google_drive') }}";
              }, 2000);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            showAlert("Error checking Google Drive connection", "danger");
          });
      }

      function launchDrivePicker() {
        // First get the access token
        fetch("/get_drive_token")
          .then((response) => response.json())
          .then((data) => {
            if (data.token) {
              const picker = new google.picker.PickerBuilder()
                .addView(google.picker.ViewId.FOLDERS)
                .setOAuthToken(data.token)
                .setDeveloperKey("{{ google_api_key }}")
                .setCallback(pickerCallback)
                .build();
              picker.setVisible(true);
            } else {
              showAlert("Error getting access token", "danger");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            showAlert("Error launching Drive Picker", "danger");
          });
      }

      function pickerCallback(data) {
        if (data.action === google.picker.Action.PICKED) {
          const folder = data.docs[0];
          document.getElementById("folderPath").value = folder.name;
          document.getElementById("folderName").textContent = folder.name;
          document.getElementById("selectedFolderInfo").style.display = "block";
          document.getElementById("analyzeBtn").disabled = false;

          sessionStorage.setItem(
            "selectedFolder",
            JSON.stringify({
              id: folder.id,
              name: folder.name,
            })
          );

          showAlert("Folder selected successfully!", "success");
        }
      }

      // Add event listeners for the service forms
      document
        .getElementById("analyzeForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          analyzeFiles();
        });

      function analyzeFiles() {
        const analyzeBtn = document.getElementById("analyzeBtn");
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Analyzing...';

        fetch("/analyze_files")
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              showToast("Error", data.error, "error");
              return;
            }

            // Update summary stats
            document.getElementById("totalFiles").textContent =
              data.total_files;
            document.getElementById("totalCO2").textContent =
              data.total_co2.toFixed(2);
            document.getElementById("potentialReduction").textContent =
              data.potential_reduction.toFixed(2);

            // Show results section
            document.getElementById("fileAnalysisResults").style.display =
              "block";

            // Populate file cards
            const fileCards = document.getElementById("fileCards");
            fileCards.innerHTML = "";

            data.files.forEach((file) => {
              const card = createFileCard(file);
              fileCards.appendChild(card);
            });
          })
          .catch((error) => {
            console.error("Error:", error);
            showToast(
              "Error",
              "An error occurred while analyzing files",
              "error"
            );
          })
          .finally(() => {
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML =
              '<i class="fas fa-search"></i> Analyze Files';
          });
      }

      function createFileCard(file) {
        const card = document.createElement("div");
        card.className = "file-card";

        const maxCO2 = 100; // Set a reasonable maximum for the progress bar
        const co2Percentage = (file.co2_emission / maxCO2) * 100;

        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="mb-2">${file.name}</h5>
                    <div class="file-stats">
                        <div class="stat-item">
                            <i class="fas fa-weight-hanging"></i>
                            <span>${formatFileSize(file.size)}</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-leaf"></i>
                            <span>${file.co2_emission.toFixed(2)} g/year</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-clock"></i>
                            <span>Last accessed: ${new Date(
                              file.lastAccessed
                            ).toLocaleDateString()}</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-eye"></i>
                            <span>${file.accessCount} times accessed</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-danger btn-sm" onclick="deleteFile('${
                  file.id
                }')">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
            <div class="carbon-indicator">
                <div class="carbon-bar" style="width: ${Math.min(
                  co2Percentage,
                  100
                )}%"></div>
            </div>
        `;

        return card;
      }

      function deleteFile(fileId) {
        if (
          confirm(
            "Are you sure you want to delete this file? This action cannot be undone."
          )
        ) {
          fetch(`/delete_file/${fileId}`, {
            method: "POST",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                showToast("Error", data.error, "error");
              } else {
                showToast("Success", "File deleted successfully");
                analyzeFiles(); // Refresh the analysis
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              showToast(
                "Error",
                "An error occurred while deleting the file",
                "error"
              );
            });
        }
      }

      document
        .getElementById("scanDuplicatesBtn")
        .addEventListener("click", function () {
          const button = this;
          const spinner = document.getElementById("scanningSpinner");
          const results = document.getElementById("scanResults");
          const errorDiv = document.getElementById("scanError");

          // Reset UI
          button.disabled = true;
          spinner.style.display = "block";
          results.style.display = "none";
          errorDiv.style.display = "none";
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Scanning...';

          fetch("/scan_duplicates")
            .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                throw new Error(data.error);
              }

              // Update scan results with the correct element IDs
              document.getElementById("scanTotalFiles").textContent =
                data.total_files;
              document.getElementById("duplicateGroups").textContent =
                data.duplicate_groups_count;
              document.getElementById("scanTotalCO2").textContent =
                formatCO2Emission(data.total_co2);
              document.getElementById("duplicateCO2").textContent =
                formatCO2Emission(data.duplicate_co2);

              // Clear and populate duplicate files list
              const duplicateList =
                document.getElementById("duplicateFilesList");
              duplicateList.innerHTML = "";

              if (data.duplicate_groups.length === 0) {
                duplicateList.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            No duplicate files found! Your drive is well organized.
                        </div>
                    `;
              } else {
                data.duplicate_groups.forEach((group, index) => {
                  const original = group.original;
                  const originalSize = formatFileSize(original.size);

                  const groupElement = document.createElement("div");
                  groupElement.className = "list-group-item mb-3";
                  groupElement.innerHTML = `
                            <div class="mb-3">
                                <h6 class="text-success mb-2">
                                    <i class="fas fa-file"></i> Original File
                                </h6>
                                <div class="ms-3 p-2 bg-light rounded">
                                    <p class="mb-1"><strong>${
                                      original.name
                                    }</strong></p>
                                    <div class="d-flex flex-wrap gap-3">
                                        <small class="text-muted">
                                            <i class="fas fa-weight-hanging"></i> Size: ${originalSize}
                                        </small>
                                        <small class="text-muted">
                                            <i class="fas fa-leaf"></i> CO2: ${formatCO2Emission(
                                              original.co2_emission
                                            )}
                                        </small>
                                        <small class="text-muted">
                                            <i class="fas fa-calendar"></i> Created: ${new Date(
                                              original.createdTime
                                            ).toLocaleDateString()}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h6 class="text-danger mb-2">
                                    <i class="fas fa-copy"></i> Duplicate Files
                                </h6>
                                <div class="ms-3">
                                    ${group.duplicates
                                      .map((duplicate) => {
                                        const duplicateSize = formatFileSize(
                                          duplicate.size
                                        );
                                        return `
                                            <div class="d-flex justify-content-between align-items-start mb-2 p-2 bg-light rounded">
                                                <div>
                                                    <p class="mb-1"><strong>${
                                                      duplicate.name
                                                    }</strong></p>
                                                    <div class="d-flex flex-wrap gap-3">
                                                        <small class="text-muted">
                                                            <i class="fas fa-weight-hanging"></i> Size: ${duplicateSize}
                                                        </small>
                                                        <small class="text-muted">
                                                            <i class="fas fa-leaf"></i> CO2: ${formatCO2Emission(
                                                              duplicate.co2_emission
                                                            )}
                                                        </small>
                                                        <small class="text-muted">
                                                            <i class="fas fa-calendar"></i> Created: ${new Date(
                                                              duplicate.createdTime
                                                            ).toLocaleDateString()}
                                                        </small>
                                                    </div>
                                                </div>
                                                <button class="btn btn-danger btn-sm" onclick="deleteDuplicate('${
                                                  duplicate.id
                                                }', this)">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </div>
                                        `;
                                      })
                                      .join("")}
                                </div>
                            </div>
                            <div class="mt-2 text-end">
                                <small class="text-muted">
                                    <i class="fas fa-leaf"></i> Potential CO2 reduction: ${formatCO2Emission(
                                      group.total_duplicate_co2
                                    )}
                                </small>
                            </div>
                        `;
                  duplicateList.appendChild(groupElement);
                });
              }

              // Show results
              results.style.display = "block";
            })
            .catch((error) => {
              console.error("Error:", error);
              errorDiv.querySelector("#errorMessage").textContent =
                error.message ||
                "An error occurred while scanning for duplicates";
              errorDiv.style.display = "block";
            })
            .finally(() => {
              button.disabled = false;
              spinner.style.display = "none";
              button.innerHTML =
                '<i class="fas fa-search"></i> Scan for Duplicates';
            });
        });

      function showToast(title, message, type = "success") {
        const toast = document.getElementById("optimizeToast");
        const toastHeader = toast.querySelector(".toast-header");
        const toastTitle = toast.querySelector(".toast-body h6");
        const toastMessage = toast.querySelector(".toast-body p");

        // Update toast appearance based on type
        if (type === "success") {
          toastHeader.innerHTML = `
                <i class="fas fa-check-circle text-success me-2"></i>
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            `;
        } else {
          toastHeader.innerHTML = `
                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            `;
        }

        toastTitle.textContent = title;
        toastMessage.textContent = message;

        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
      }

      function deleteDuplicate(fileId, buttonElement) {
        if (
          !confirm(
            "Are you sure you want to delete this duplicate file? It will be moved to trash."
          )
        ) {
          return;
        }

        const originalButton = buttonElement.innerHTML;
        buttonElement.disabled = true;
        buttonElement.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Deleting...';

        fetch(`/delete_duplicate/${fileId}`, {
          method: "POST",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              throw new Error(data.error);
            }

            // Show success message
            showToast(
              "File Moved to Trash",
              `${data.name} has been moved to trash. You can restore it from Google Drive if needed.`
            );

            // Remove the file's container from the UI
            const fileContainer = buttonElement.closest(".d-flex");
            fileContainer.remove();

            // If this was the last duplicate in the group, refresh the entire scan
            const duplicatesContainer =
              buttonElement.closest(".list-group-item");
            if (duplicatesContainer.querySelectorAll(".d-flex").length === 0) {
              document.getElementById("scanDuplicatesBtn").click();
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            showToast(
              "Error",
              error.message || "An error occurred while deleting the file",
              "error"
            );
            buttonElement.disabled = false;
            buttonElement.innerHTML = originalButton;
          });
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function formatCO2Emission(grams) {
        return `${grams.toFixed(2)} g/year`;
      }


      function populateTopContributors(files) {
        const tbody = document.getElementById("topContributorsTable");
        tbody.innerHTML = "";

        files.forEach((file) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                <td>${file.name}</td>
                <td>${formatFileSize(file.size)}</td>
                <td>${getFileType(file.name)}</td>
                <td>${new Date(file.lastAccessed).toLocaleDateString()}</td>
                <td>${formatCO2Emission(file.co2_emission)}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteFile('${
                      file.id
                    }')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
          tbody.appendChild(tr);
        });
      }

      function getFileType(filename) {
        const ext = filename.split(".").pop().toLowerCase();
        const typeMap = {
          pdf: "PDF Document",
          doc: "Word Document",
          docx: "Word Document",
          xls: "Excel Spreadsheet",
          xlsx: "Excel Spreadsheet",
          jpg: "Image",
          jpeg: "Image",
          png: "Image",
          mp4: "Video",
          mov: "Video",
          zip: "Archive",
        };
        return typeMap[ext] || "Other";
      }

      function navigateTo(url) {
        window.location.href = url;
        return false;
      }

      // Add this at the beginning of your script section
      document.addEventListener("DOMContentLoaded", function () {
        // Set up navigation handlers
        document.querySelectorAll("button[data-href]").forEach((button) => {
          button.addEventListener("click", function () {
            window.location.href = this.dataset.href;
          });
        });

        // Rest of your DOMContentLoaded code...
      });
      function browseFolder() {
        fetch("/browse")
          .then((res) => res.json())
          .then((data) => {
            const folder = data.folder;
            const files = data.files;

            document.getElementById("folder-path").innerText =
              "Selected Folder: " + folder;

            const fileList = document.getElementById("file-list");
            fileList.innerHTML = "";

            files.forEach((file) => {
              const fileName = file.split(/[\\/]/).pop(); // just filename to display

              fileList.innerHTML += `
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>${fileName}</span>
            <button class="btn btn-sm btn-danger delete-btn" data-file="${file}">
                <i class="fas fa-trash-alt"></i> Delete
            </button>
        </li>
    `;
            });
          })
          .catch((err) => {
            console.error(err);
            alert("Could not access File Explorer.");
          });
      }
      document.addEventListener("click", function (event) {
  if (event.target.closest(".delete-btn")) {
    const btn = event.target.closest(".delete-btn");
    const filePath = btn.getAttribute("data-path");
    const co2 = parseFloat(btn.getAttribute("data-co2")) || 0;

    if (confirm("Are you sure you want to delete this duplicate file?")) {
      fetch("/delete_local_file", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ path: filePath }),
      })
        .then((res) => res.json())
        .then((result) => {
          if (result.success) {
            btn.closest("li").remove();

            // Update duplicateCO2 and topCO2 visually (optional)
            const co2Elem = document.getElementById("duplicateCO2Local");
            if (co2Elem && co2 > 0) {
              let current = parseFloat(co2Elem.innerText) || 0;
              co2Elem.innerText = `${(current - co2).toFixed(4)} g/year`;
            }
          } else {
            alert("Failed to delete file: " + result.error);
          }
        })
        .catch((err) => {
          alert("Error deleting file: " + err.message);
        });
    }
  }
});

document.getElementById("analyzeBrowsedBtn").addEventListener("click", () => {
  document.getElementById("browsedAnalysisResults").style.display = "block";
  document.getElementById("duplicateFilesListLocal").innerHTML = "";
  document.getElementById("topEmittersListLocal").innerHTML = "";

  fetch("/browse_analyze")
    .then((res) => res.json())
    .then((data) => {
      if (data.error) {
        alert("Please select a folder using Browse first.");
        return;
      }

      // Fill header stats
      document.getElementById("scanTotalFilesLocal").innerText = data.total_files;
      document.getElementById("duplicateGroupsLocal").innerText = data.duplicate_groups;
      document.getElementById("scanTotalCO2Local").innerText = `${data.scanTotalCO2} g/year`;
      document.getElementById("duplicateCO2Local").innerText = `${data.duplicateCO2} g/year`;

     // Fill top emitters
      const topEmitters = data.topEmitters || [];
      const topTable = document.getElementById("topEmittersListLocal");
      topTable.innerHTML = ""; // clear existing rows

      topEmitters.forEach((file, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${file.name}</td>
          <td>${(file.size / 1024).toFixed(2)} KB</td>
          <td>${file.carbon || file.co2} g COâ‚‚/year</td>
          <td>${file.last_access || 'Unavailable'}</td> <!-- âœ… Add this line -->
        `;
        topTable.appendChild(row);
      });


      // Fill duplicate file groups
      const duplicateGroups = data.duplicateFiles || [];
      const dupList = document.getElementById("duplicateFilesListLocal");

      duplicateGroups.forEach((group, i) => {
        const div = document.createElement("div");
        div.className = "card mb-3";
        div.innerHTML = `
          <div class="card-header">
            <strong>Duplicate Group ${i + 1}</strong>
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
              <div>
                <i class="fas fa-file me-2"></i>
                ${group.original.name}
                <span class="badge bg-primary ms-2">Original</span>
                <span class="badge bg-secondary ms-2">${group.original.carbon} g COâ‚‚</span>
              </div>
            </li>
            ${group.duplicates
              .map((dup) => {
                return `
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <i class="fas fa-copy me-2"></i>
                      ${dup.name}
                      <span class="badge bg-danger ms-2">Duplicate</span>
                      <span class="badge bg-secondary ms-2">${dup.carbon} g COâ‚‚</span>
                    </div>
                    <button class="btn btn-sm btn-outline-danger delete-btn" data-path="${dup.path}" data-co2="${dup.carbon}">
                      <i class="fas fa-trash-alt"></i> Delete
                    </button>
                  </li>
                `;
              })
              .join("")}
          </ul>
        `;
        dupList.appendChild(div);
      });
    })
    .catch((err) => {
      alert("Error analyzing local files: " + err.message);
    });
});

document.addEventListener("click", function (e) {
  if (e.target && e.target.classList.contains("delete-btn")) {
    const filePath = e.target.getAttribute("data-file");
    const carbon = parseFloat(e.target.getAttribute("data-carbon")) || 0;

    if (confirm(`Delete duplicate?\n${filePath}`)) {
      fetch("/delete_local_file", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ path: filePath }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.success) {
            e.target.closest(".list-group-item").remove();

            const co2Elem = document.getElementById("co2Saving");
            let current = parseFloat(co2Elem.innerText) || 0;
            let updated = (current - carbon).toFixed(4);
            co2Elem.innerText = `${updated} g/year`;

            alert("File deleted successfully!");
          } else {
            alert("Delete failed: " + data.error);
          }
        });
    }
  }
});

    </script>
  </body>
</html>
